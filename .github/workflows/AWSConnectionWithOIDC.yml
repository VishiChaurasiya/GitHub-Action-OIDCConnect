name: AWS OIDC → EC2 SSM Connectivity Test

on:
  workflow_dispatch:

env:
  AWS_REGION: ap-south-1

permissions:
  id-token: write
  contents: read

jobs:
  OIDC-SSM-Test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------
      # OIDC → AWS Authentication
      # -------------------------------
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-OIDC-Test-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify assumed role
        run: aws sts get-caller-identity

      # -------------------------------
      # EC2 Connectivity via SSM
      # -------------------------------
      - name: Run test command on EC2 via SSM
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters '{
              "commands": [
                "echo \"✅ OIDC → AWS → EC2 SSM working\"",
                "date",
                "whoami",
                "echo \"Hello from GitHub Actions\" > /tmp/oidc-test.txt",
                "cat /tmp/oidc-test.txt"
              ]
            }' \
            --query "Command.CommandId" \
            --output text)

          echo "SSM Command ID: $COMMAND_ID"

          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }}

          echo "=== SSM Output ==="
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --query "StandardOutputContent" \
            --output text
